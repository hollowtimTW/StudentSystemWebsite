@section Styles
{
    <!-- 核心：Tocas UI -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocas/4.2.5/tocas.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocas/4.2.5/tocas.min.js"></script>

    <!-- 字體：Noto Sans TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.min.css" rel="stylesheet">
    <style>
        .meta-bottom {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .accordion .accordion-item .accordion-button:hover {
            background-color: rgba(196,206,157,0.2);
        }

        #main {
            background-color: #ffff;
            min-height: 1243.05px;
        }
    </style>
}
@* @User.Identity?.Name 這能抓到使用者的名稱 *@
@* @User?.FindFirst("FullName")?.Value 也能抓到使用者的名稱*@
@* @User?.FindFirst("StudentId")?.Value 這能抓到使用者的PK *@
<div id="showorNot">
    <section id="blog" class="blog">
        <div class="container" data-aos="fade-up">
            <div class="row g-5">
                <!-- 左方側邊欄：標籤分類 -->
                <div class="col-lg-7">
                    <article class="blog-details">
                        <h2 class="title m-3">外送詳細資訊</h2>
                        <div class="accordion">
                            <div class="accordion-item">
                                <div class="column is-light"></div>
                                <div class="ts-grid is-relaxed has-top-spaced-big is-light">
                                    <div class="column is-16-wide">
                                        <div class="ts-header is-heavy is-big">學員資料</div>
                                        <div class="ts-grid is-relaxed has-top-spaced">
                                            <div class="column is-16-wide">
                                                <div class="ts-text is-label fs-5">姓名</div>
                                                <div class="ts-input has-top-spaced is-large">
                                                    <input type="text" disabled id="姓名">
                                                </div>
                                            </div>

                                            <div class="column is-16-wide">
                                                <div class="ts-grid is-3-columns is-relaxed">
                                                    <div class="column">
                                                        <div class="ts-text is-label fs-5">班級</div>
                                                        <div class="ts-input has-top-spaced is-large">
                                                            <input type="text" disabled id="班級">
                                                        </div>
                                                    </div>
                                                    <div class="column">
                                                        <div class="ts-text is-label fs-5">電話</div>
                                                        <div class="ts-input has-top-spaced is-large">
                                                            <input type="text" disabled id="電話">
                                                        </div>
                                                    </div>
                                                    <div class="column">
                                                        <div class="ts-text is-label fs-5">電子信箱</div>
                                                        <div class="ts-input has-top-spaced is-large">
                                                            <input type="text" disabled id="電子信箱">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="column is-16-wide">
                                                <div class="ts-wrap is-vertical">
                                                    <div class="ts-divider"></div>
                                                    <label class="ts-checkbox">
                                                        <input type="checkbox" checked="">
                                                        <span class="ts-text is-small">儲存這個地址供下次使用</span>
                                                    </label>
                                                    <label class="ts-checkbox">
                                                        <input type="checkbox" checked="">
                                                        <span class="ts-text is-small">我願意接收促銷通知</span>
                                                    </label>
                                                    <div class="ts-divider"></div>

                                                    <div class="ts-header is-heavy is-big">付款方式</div>
                                                    <div class="ts-tab is-fluid">

                                                        <a class="item is-active" data-tab="catch">現金支付</a>

                                                        <a class="item" data-tab="logs">信用卡付款</a>

                                                        <a class="item" data-tab="ATM">第三方支付</a>

                                                    </div>
                                                </div>
                                            </div>
                                            @* 信用卡付款 *@
                                            <div class="ts-segment column is-16-wide" data-name="logs">
                                                <div class="column is-16-wide">
                                                    <button class="ts-button is-fluid" onclick="SendToNewebPay('VACC')">使用信用卡付款</button>
                                                </div>
                                            </div>
                                            @* 現金支付 *@
                                            <div class="ts-segment column is-16-wide" data-name="catch">
                                                <div class="column is-16-wide">
                                                    <button class="ts-button is-fluid" id="chickOrder">確定取餐付款</button>
                                                </div>
                                            </div>
                                            @* ATM轉帳 *@
                                            <div class="ts-segment column is-16-wide" data-name="ATM">
                                                <div class="column is-16-wide">
                                                    <button class="ts-button is-fluid">使用ATM轉帳</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="meta-bottom">
                            <div class="btn-group me-2" role="group" aria-label="First group" id="page">
                                <!-- 載入分頁 -->
                            </div>
                        </div><!-- End meta bottom -->
                    </article><!-- End blog post -->
                </div>

                <div class="col-lg-5">
                    <!-- 內容 -->
                    <article class="blog-details">
                        <h2 class="title m-3">訂單總計金額</h2>
                        <div class="accordion">
                            <div class="accordion-item">
                                <div class="column is-light">

                                    <div class="ts-grid is-middle-aligned">
                                        <div class="column is-fluid">
                                            <div class="ts-header is-heavy is-secondary is-big">購物項目</div>
                                        </div>
                                        <div class="column">
                                            <div class="ts-badge" id="筆數">5</div>
                                        </div>
                                    </div>
                                    @* 購物項目標題 *@
                                    <div id="orderDeatail">
                                        @* 購物項目(1) *@
                                        <div class="ts-box has-top-spaced">
                                            <div class="ts-content is-dense">
                                                <div class="ts-grid">
                                                    <div class="column is-fluid">
                                                        <span class="ts-text is-label">大麥克</span>
                                                    </div>
                                                    <div class="column">
                                                        <span class="ts-text is-description">$15</span>
                                                    </div>
                                                </div>
                                                <div class="ts-text is-description is-truncated">數量 : <span>1</span></div>
                                            </div>
                                            <div class="ts-divider"></div>
                                            @* 購物項目(1) *@

                                            @* 購物項目(2) *@
                                            <div class="ts-content is-dense">
                                                <div class="ts-grid">
                                                    <div class="column is-fluid">
                                                        <span class="ts-text is-label">橡皮擦</span>
                                                    </div>
                                                    <div class="column">
                                                        <span class="ts-text is-description">$5</span>
                                                    </div>
                                                </div>
                                                <div class="ts-text is-description is-truncated">數量 : <span>1</span></div>
                                            </div>
                                            <div class="ts-divider"></div>
                                            @* 購物項目(2) *@
                                        </div>
                                    </div>
                                    <div class="ts-content is-dense is-active mt-3">
                                        <div class="ts-grid">
                                            <div class="column is-fluid fs-4">總計（新台幣）</div>
                                            <div class="column">
                                                <span class="ts-text is-bold fs-4">$</span> <span class="ts-text is-bold fs-4" id="總額"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="meta-bottom">
                            <div class="btn-group me-2" role="group" aria-label="First group" id="page">
                                <!-- 載入分頁 -->
                            </div>
                        </div><!-- End meta bottom -->
                    </article><!-- End blog post -->
                </div>
            </div>
        </div>
    </section>

</div>
<!-- End Blog Details Section -->
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.all.min.js"></script>
    <script>
        const studentID = @User?.FindFirst("StudentId")?.Value;
        //let totalcash;
        //let email;
        //網頁載入開始
        $(document).ready(function () {
            shoppingCart();
            studentinfor();
        })
        //呼叫購物車資訊沒有的話出現預設畫面
        const shoppingCart = () => {
            $.ajax({
                url: `@Url.Content("~/tOrder_StoreAPI/shoppingCar")?id=${studentID}`,
                success: (datas) => {
                    if (datas.待購物清單.length == 0) {
                        const title = `
                        <div class="ts-blankslate is-light">
                          <span class="ts-icon is-heading is-cart-shopping-icon"></span>
                            <div class="header" style="background-color: #ffff;">
                             <div class="ts-header is-big is-center-aligned">購物車是空的</div>
                            </div>
                           <div class="description is-large">請購買些商品之後再回來查看</div>
                            <div class="action">
                               <a class="ts-button" href="/ordering_system/orderforStudent/Studentrestaurant">瀏覽商品</a>
                             </div>
                         </div>`
                        $('#showorNot').html(title);
                    }
                    else {
                        $('#筆數').text(datas.筆數);
                        $('#總額').text(datas.總額);
                        const datalist = datas.待購物清單.map(a => {
                            const { 購物車ID, 餐點圖片, 餐點數量, 餐點名稱, 小計, 餐點ID } = a;
                            return (`
                                             <div class="ts-box has-top-spaced">
                                                <div class="ts-content is-dense">
                                                    <div class="ts-grid">
                                                        <div class="column is-fluid">
                                                           <span class="ts-text is-label fs-4">${餐點名稱}</span>
                                                        </div>
                                                        <div class="column">
                                                          <span class="ts-text is-description fs-4 fw-bold">$${小計}</span>
                                                        </div>
                                                    </div>
                                                  <div class="ts-text is-description is-truncated fs-5">數量 : <span>${餐點數量}</span></div>
                                                </div>
                                                <div class="ts-divider"></div>
                            `);
                        });
                        $('#orderDeatail').html(datalist);
                    }
                },
                error: () => {
                    console.log("載入問題")
                }
            })
        }
        //抓取學生資訊
        const studentinfor = () => {
            $.ajax({
                url: `@Url.Content("~/tOrder_StoreAPI/studentinformation")?id=${studentID}`,
                success: (data) => {
                    $('#姓名').val(data.學生姓名);
                    $('#班級').val(data.班級);
                    $('#電話').val(data.電話);
                    $('#電子信箱').val(data.電子信箱);
                },
                error: () => {
                    console.log('學生資料錯誤')
                }
            })
        }
        //確認現金送出訂單
        $('#chickOrder').click(() => {
            Swal.fire({
                title: "確認成立訂單",
                text: "確定是否成立送出訂單",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "確認送出"
            }).then((result) => {
                if (result.isConfirmed) {
                    const type = `現金支付`;
                    $.ajax({
                        //將購物車轉成訂單送出，跳轉回首頁
                        url: `@Url.Content("~/tOrder_StoreAPI/CreatOrder")?id=${studentID}&type=${type}`,
                        method: 'post',
                        success: () => {
                            Swal.fire({
                                title: "完成訂單成立",
                                text: "再請稍後馬上為您準備餐點",
                                icon: "success"
                            }).then(()=>{
                                window.location.href = `/Template/index`;
                            })
                        },
                        error: () => {
                            console.log('訂單問題稍後再試')
                        }
                    })
                }
            });
        })
        //傳送至藍新金流
        const SendToNewebPay=(ChannelID)=>{
            // 組合表單資料
            var postData = {};
            postData['ChannelID'] = ChannelID;
            postData['MerchantID'] = '@ViewData["MerchantID"]';
            postData['MerchantOrderNo'] = '@ViewData["MerchantOrderNo"]';
            postData['ItemDesc'] = '測試商品';
            postData['ExpireDate'] = '@ViewData["ExpireDate"]';
            postData['ReturnURL'] = '@ViewData["ReturnURL"]';
            postData['CustomerURL'] = '@ViewData["CustomerURL"]';
            postData['NotifyURL'] = '@ViewData["NotifyURL"]';
            postData['ClientBackURL'] = '@ViewData["ClientBackURL"]';
            postData['Amt'] = $('#總額').text();
            postData['Email'] = $('#電子信箱').val();
            $.ajax({
                url: '@Url.Content("~/ordering_system/orderforStudent/SendToNewebPay")',
                method: 'POST',
                dataType: 'json',
                data: { inModel: postData},
                success: function (returnObj) {
                    // 呼叫藍新金流 API
                    const form = document.createElement('form');
                    form.method = 'post';
                    form.action = 'https://ccore.newebpay.com/MPG/mpg_gateway';//藍新金流驗證網址(測試環境)

                    for (const key in returnObj) {
                        if (returnObj.hasOwnProperty(key)) {
                            const hiddenField = document.createElement('input');
                            hiddenField.type = 'hidden';
                            hiddenField.name = key;
                            hiddenField.value = returnObj[key];
                            form.appendChild(hiddenField);
                        }
                    }
                    document.body.appendChild(form);
                    form.submit();
                },
                error: function (err) {
                    alert(err.status + " " + err.statusText + '\n' + err.responseText);
                }
            });
        }
    </script>
}