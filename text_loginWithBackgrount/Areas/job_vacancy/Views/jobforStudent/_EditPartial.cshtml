@model ResumeCreateViewModel
<style>
    <link href="~/css/job_vacancy/jobcommonstyle.css" rel="stylesheet"/>

</style>
<section class="Resume-Edit">
    <div class="container-fluid">
        <form asp-action="Edit" class="formResume" id="formEdit" enctype="multipart/form-data">
            <!--模型驗證錯誤的摘要-->
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <!--隱藏學員ID值-->
            <input type="hidden" asp-for="StudentID" />
            <!--隱藏履歷ID值-->
            <input type="hidden" asp-for="ResumeID" />

            <!-- 1-1.學生資料-->
            <div class="row dialog container-fluid">
                <div class="col-md-6">
                    <div class="form-group flex-container">
                        <label asp-for="ResumeTitle" class="control-label"></label>
                        <input asp-for="ResumeTitle" class="form-control" />
                        <span asp-validation-for="ResumeTitle" class="text-danger"></span>
                    </div>
                    <div class="form-group flex-container">
                        <label asp-for="Name" class="control-label"></label>
                        <input asp-for="Name" class="form-control" />
                        <span asp-validation-for="Name" class="text-danger"></span>
                    </div>
                    <div class="form-group flex-container">
                        <label asp-for="Birth" class="control-label"></label>
                        <input asp-for="Birth" type="date" class="form-control" value="@Model.Birth?.ToString("yyyy-MM-dd")" />
                        <span asp-validation-for="Birth" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="Gender" class="control-label col-md-3"></label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="Gender" id="gender1" value="男" @(Model.Gender == "男" ? "checked" : "")>
                            <label class="form-check-label" for="gender1">男</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="Gender" id="gender2" value="女" @(Model.Gender == "女" ? "checked" : "")>
                            <label class="form-check-label" for="gender2">女</label>
                        </div>
                        <span asp-validation-for="Gender" class="text-danger"></span>
                    </div>
                    <div class="form-group flex-container">
                        <label asp-for="Phone" class="control-label"></label>
                        <input asp-for="Phone" class="form-control" />
                        <span asp-validation-for="Phone" class="text-danger"></span>
                    </div>
                    <div class="form-group flex-container">
                        <label asp-for="Email" class="control-label"></label>
                        <input asp-for="Email" class="form-control" />
                        <span asp-validation-for="Email" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-center">
                        @await Html.PartialAsync("_ShowPhotoPartial")
                    </div>
                    <input asp-for="Photo" type="file" id="Photo" class="form-control mt-2" accept="image/*" />
                    <span asp-validation-for="Photo" class="text-danger"></span>
                </div>
            </div>

            <!-- 1-2.學歷-->
            <div class="row dialog container-fluid">
                <div class="col-md-6">
                    <div class="form-group flex-container">
                        <label asp-for="School" class="control-label"></label>
                        <input asp-for="School" class="form-control" />
                        <span asp-validation-for="School" class="text-danger"></span>
                    </div>
                    <div class="form-group flex-container">
                        <label asp-for="Department" class="control-label"></label>
                        <input asp-for="Department" class="form-control" />
                        <span asp-validation-for="Department" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group flex-container">
                        <label asp-for="Academic" class="control-label"></label>
                        <select asp-for="Academic" class="form-control">
                            <option value="">無</option>
                            <option value="學士" selected="@(Model.Academic == "學士")">學士</option>
                            <option value="副學士" selected="@(Model.Academic == "副學士")">副學士</option>
                            <option value="碩士" selected="@(Model.Academic == "碩士")">碩士</option>
                            <option value="博士" selected="@(Model.Academic == "博士")">博士</option>
                        </select>
                        <span asp-validation-for="Academic" class="text-danger"></span>
                    </div>
                    <div class="form-group row">
                        <label asp-for="Graduated" class="control-label col-md-3"></label>
                        <div class="col-md-8">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="Graduated" id="graduated1" value="畢業" @(Model.Graduated == "畢業" ? "checked" : "")>
                                <label class="form-check-label" for="graduated1">畢業</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="Graduated" id="graduated2" value="肄業" @(Model.Graduated == "肄業" ? "checked" : "")>
                                <label class="form-check-label" for="graduated2">肄業</label>
                            </div>
                            <span asp-validation-for="Graduated" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>


            <!-- 2.技能能力-->
            <div class="row dialog container-fluid">
                <div class="form-group">
                    <label asp-for="Skill" class="control-label"></label>
                    <textarea asp-for="Skill" class="form-control"></textarea>
                    <span asp-validation-for="Skill" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="Language" class="control-label"></label>
                    <textarea asp-for="Language" class="form-control"></textarea>
                    <span asp-validation-for="Language" class="text-danger"></span>
                </div>
            </div>

            <!-- 3.工作經驗-->
            <div class="row dialog container-fluid">
                <div class="form-group col-sm-auto">
                    <label asp-for="WorkExperience" class="control-label"></label>
                </div>
                <div class="form-group form-check form-switch col-md-auto ms-auto">
                    <input id="workExpCheck" class="form-check-input" type="checkbox" @(Model.WorkExperience == "N" ? "checked" : "")>
                    <label for="workExpCheck" class="form-check-label">沒有工作經驗</label>
                    <span asp-validation-for="WorkExperience" class="text-danger"></span>
                </div>
                <div class="col-12">
                    <button id="btnExpAdd" type="button" class="btn btn-normal">選擇或新增</button>
                </div>
                <div class="col-12" id="workExp_context">
                    <!-- 學員工作經驗 _workExpPartial -->
                </div>
            </div>

            <!-- 4.求職條件-->
            <div class="row dialog container-fluid">
                <div class="form-group flex-container">
                    <label asp-for="HopeJobTitle" class="control-label"></label>
                    <input asp-for="HopeJobTitle" class="form-control" placeholder="盡量寫明確一點，如：前端工程師、網頁設計師" />
                    <span asp-validation-for="HopeJobTitle" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="WorkType" class="control-label col-md-2"></label>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="WorkType" id="workType1" value="全職" @(Model.WorkType == "全職" ? "checked" : "")>
                        <label class="form-check-label" for="workType1">全職</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="WorkType" id="workType2" value="兼職" @(Model.WorkType == "兼職" ? "checked" : "")>
                        <label class="form-check-label" for="workType2">兼職</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="WorkType" id="workType3" value="派遣" @(Model.WorkType == "派遣" ? "checked" : "")>
                        <label class="form-check-label" for="workType3">派遣</label>
                    </div>
                    <span asp-validation-for="WorkType" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="WorkTime" class="control-label col-md-2"></label>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="WorkTime" id="workTime1" value="日班" @(Model.WorkTime == "日班" ? "checked" : "")>
                        <label class="form-check-label" for="workTime1">日班</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="WorkTime" id="workTime2" value="晚班" @(Model.WorkTime == "晚班" ? "checked" : "")>
                        <label class="form-check-label" for="workTime2">晚班</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="WorkTime" id="workTime3" value="假日班" @(Model.WorkTime == "假日班" ? "checked" : "")>
                        <label class="form-check-label" for="workTime3">假日班</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="WorkTime" id="workTime4" value="大夜班" @(Model.WorkTime == "大夜班" ? "checked" : "")>
                        <label class="form-check-label" for="workTime4">大夜班</label>
                    </div>
                    <span asp-validation-for="WorkTime" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="WorkShift" class="control-label col-md-2"></label>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="WorkShift" id="workShiftCheck" @(Model.WorkShift == "Y" ? "checked" : "")>
                        <label class="form-check-label" for="workShiftCheck">可配合輪班</label>
                    </div>
                    <span asp-validation-for="WorkShift" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="HopeSalary" class="control-label col-md-2"></label>
                    <div class="form-check form-check-inline">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="HopeSalary" id="hopeSalary1" value="面議">
                            <label class="form-check-label" for="hopeSalary1">面議</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="HopeSalary" id="hopeSalary2" value="論件計酬">
                            <label class="form-check-label" for="hopeSalary2">論件計酬</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="HopeSalary" id="hopeSalary3">
                            <label class="form-check-label" for="hopeSalary3">自訂薪資</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-control" type="text" name="HopeSalary" id="salaryInput" style="visibility: hidden">
                        </div>
                    </div>
                    <input asp-for="HopeSalary" class="form-control" hidden />
                    <span asp-validation-for="HopeSalary" class="text-danger"></span>
                </div>
                <div class="form-group flex-container">
                    <label asp-for="HopeLocation" class="control-label"></label>
                    <input asp-for="HopeLocation" class="form-control" />
                    <span asp-validation-for="HopeLocation" class="text-danger"></span>
                </div>
            </div>

            <!-- 5.自傳-->
            <div class="row dialog container-fluid">
                <div class="form-group">
                    <label asp-for="Autobiography" class="control-label"></label>
                    <div class="document-editor">
                        <div id="AutobiographyEditor" name="Autobiography" placeholder="請在這裡填寫內容">
                        </div>
                    </div>
                    <span asp-validation-for="Autobiography" class="text-danger"></span>
                </div>
            </div>
        </form>
    </div>
</section>

<script>

    //恢復已選擇的工作經驗項目的勾選狀態
    function restoreCheckedItems() {
        if (typeof selectedWorkExpIDs !== 'undefined') {

            // 根據記錄的id重新設置勾選狀態
            $('.cbWorkExp').each(function () {
                var itemId = $(this).attr('workExp-id');
                var isChecked = selectedWorkExpIDs.includes(itemId);
                $(this).prop('checked', isChecked);

                // 輸出到控制台
                if (isChecked) {
                    console.log('項目 ' + itemId + ' 已經被勾選');
                }
            });
        }
    }

    //呼叫學員工作經驗資料（返回_workExpPartial）
    function callWorkExp(restoreChecked = false) {

        const workExpContext = $("#workExp_context");
        $.ajax({
            type: 'GET',
            url: '/job_vacancy/jobforStudent/GetMyWorkExp/',
            data: { studentID: @Model.StudentID, resumeID: @Model.ResumeID},
            success: function (result) {
                console.log('呼叫工作經驗資料 success');

                //隱藏「新增或選擇」按鈕
                $('#btnExpAdd').hide();

                // 清空並設置內容
                workExpContext.html(result);

                // 如果需要恢復勾選狀態，則調用 restoreCheckedItems() 函式
                if (restoreChecked) {
                    restoreCheckedItems();
                }
            },
            error: function (error) {
                console.error('呼叫工作經驗資料 error', error);
                // 顯示錯誤提示給用戶
                workExpContext.html(`<div class="alert alert-danger" role="alert">請求失敗：${error.statusText}</div>`);
            }
        });
    }

    //照片預覽函式
    function previewImage(inputFile, img) {
        if (inputFile.files && inputFile.files[0]) {
            let allowType = "image.*";
            // 檢查上傳的檔案類型是否符合允許的檔案類型
            if (inputFile.files[0].type.match(allowType)) {
                // 創建 FileReader 物件用於讀取檔案
                let reader = new FileReader();
                reader.onload = function (e) {
                    $(img).attr('src', e.target.result); // 將 img 包裝在 $() 函數中
                    $(img).attr('title', inputFile.files[0].name); // 將 img 包裝在 $() 函數中
                    //$(".btn").prop('disabled', false);
                };
                // 開始讀取檔案內容，這會觸發上述的 reader.onload 事件
                reader.readAsDataURL(inputFile.files[0]);
            } else {
                alert("不支援的檔案上傳格式！");
                //$(".btn").prop('disabled', true);
            }
        }
    }

    $(document).ready(function () {

        // ========= 載入資料時 =========

        // 宣告紀錄履歷工作經驗勾選情形的列表
        let selectedWorkExpIDs = [];

        // 處理希望薪資的選項
        const hopeSalary = "@Html.Raw(Model.HopeSalary)".trim();
        switch (hopeSalary) {
            case "面議":
                document.getElementById('hopeSalary1').checked = true;
                break;
            case "論件計酬":
                document.getElementById('hopeSalary2').checked = true;
                break;
            default:
                document.getElementById('hopeSalary3').checked = true;
                document.getElementById('salaryInput').value = hopeSalary;
                document.getElementById('salaryInput').style.visibility = "visible";
                break;
        }

        // 處理工作經驗的匯入
        if ('@Model.WorkExperience' === 'Y') {
            callWorkExp();
        }

        // ========= CKEditor 相關 =========
        ClassicEditor
        .create( document.querySelector('#AutobiographyEditor'), {
            toolbar: {
                items: [
                    'heading',
                    '|', 'bold', 'italic',
                    '|', 'fontfamily', 'fontsize', 'fontColor', 'fontBackgroundColor',
                    '|', 'bulletedList', 'numberedList', 'outdent', 'indent',
                    '|', 'undo', 'redo',
                    '-',
                    'link', 'insertImage', 'insertTable', 'mediaEmbed', 'blockQuote',
                ],
                shouldNotGroupWhenFull: true
            },
        } )
        .then(editor => {
            //賦予編輯器實例給變數
            update_editor = editor;

            // 設置初始內容
            let autobiographyContent = '@Html.Raw(Model.Autobiography)';
            update_editor.setData(autobiographyContent);
        })
        .catch( error => {
            console.error('There was an error initializing the editor', error);
        } );

        // ====================== 事件監聽器 ===========================


        //有無工作經驗
        document.getElementById('workExpCheck').addEventListener('change', function (event) {
            if (event.target.checked) {
                selectedWorkExpIDs = []; //清空所有選擇的工作經驗（暫時無用）

                $('#expListArea').hide();
                $('#expSelectArea').hide();
                $('#btnExpAdd').show();
            }
        });

        // 選擇或新增工作經驗
        document.getElementById('btnExpAdd').addEventListener('click', function (event) {

            var workExpCheck = document.getElementById('workExpCheck');
            if (workExpCheck.checked) {
                callWorkExp(true);
            } else {
                callWorkExp();
            }
        });

        // 顯示圖片
        document.getElementById('Photo').addEventListener('change', function (event) {
            var inputFile = event.target;
            var img = document.getElementById('previewImage');
            previewImage(inputFile, img);
        });

        // 當選擇"自訂薪資"時，顯示薪資輸入框
        document.getElementById('hopeSalary3').addEventListener("change", function () {
            if (this.checked) {
                document.getElementById('salaryInput').style.visibility = "visible";
            }
        });

        // 當選擇其他選項時，隱藏薪資輸入框
        document.querySelectorAll('input[name="HopeSalary"]:not(#hopeSalary3)').forEach(function (radio) {
            radio.addEventListener("change", function () {
                document.getElementById('salaryInput').style.visibility = "hidden";
            });
        });

    });


</script>