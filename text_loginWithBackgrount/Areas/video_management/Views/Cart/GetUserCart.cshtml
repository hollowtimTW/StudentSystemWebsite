@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@model T影片ShoppingCart
@{

}

<div style="width:60%;margin:auto" class="mt-2">
    @if (Model != null && Model.T影片CartDetails != null && Model.T影片CartDetails.Count > 0)
    {
        <h5>我的購物車</h5>

        <table class="table table-striped" id="videoTable">
            <tr>
                <th>名字</th>
                <th>Video</th>
                <th>分類</th>
                <th>單價</th>
                <th>總價</th>
                <th>更改筆數</th>
            </tr>
            @foreach (var item in Model.T影片CartDetails)
            {
                <tr>
                    <td>@item.FVideo.FVideoName</td>
                    <td>
                        @if (string.IsNullOrEmpty(item.FVideo.FVideoName))
                        {
                            <video src="/video/no video.png" style="width:60px;height:80px" />
                        }
                        else
                        {
                          @*   <video controls style="width: 16rem; height:16rem">
                                @{
                                    var videoPath = $"~/video/{item.FVideo.FVideoName}.mp4";
                                    Console.WriteLine($"Generated Video Path: {videoPath}");
                                }
                                <source src="@Url.Content(videoPath)" type="video/mp4" style="width:80px;height:100px">
                            </video> *@
                            string encodedVideoName = Uri.EscapeDataString(@item.FVideo.FVideoName);

                            <img src="@Url.Content("~/video/看板封面/" + encodedVideoName + ".png")" alt="Video Thumbnail" style="width: 10rem; height: 10rem;">

                            
                        }
                    </td>
                   @*  <td>@item.FVideo.Genre.GenreName</td>
                    <td>@item.FVideo.FPrice X @item.Quantity</td>
                    <td>@(item.FVideo.FPrice * item.Quantity)</td> *@


                    <td>@(item.FVideo.Genre.GenreName)</td>
                    <td>@item.FVideo.FPrice.ToString("0.##") X @item.Quantity</td>
                    <td>@string.Format("{0:0.##}", item.FVideo.FPrice * item.Quantity)</td>
                    <td>
                      @*   <a class="btn btn-info add-btn" data-videoId=@item.FVideoId>+</a>

                        <a class="btn btn-info" href="/video_management/cart/removeitem/@item.FVideoId">-</a> *@
                        <a class="btn btn-success" href="/video_management/Cart/AddItem?FvideoId=@item.FVideoId&&redirect=1">+</a>
                        <a class="btn btn-success" href="/video_management/Cart/RemoveItem?FvideoId=@item.FVideoId">-</a>
                    </td>
                </tr>
            }
        </table>

        <div class="my-2">
            <h5>總價: </h5>
     @*        @(Model.T影片CartDetails.Select(item => item.FVideo.FPrice * item.Quantity).Sum()) *@
            @(Model.T影片CartDetails.Select(item => item.FVideo.FPrice * item.Quantity).Sum().ToString("0.##"))

        </div>

        <div class="my-2">
     @*   <a class="btn btn-success" href="/video_management/Cart/Checkout">付款</a> *@
            <button id="paymentButton" type="button" class="btn btn-success">Linepay付款</button>
          @*   <button onclick="requestPayment()"> Line Pay 付款</button> *@

        </div>

    }
    else
    {
        <section> <h5>親愛的顧客，您的購物車是空的喔!</h5><br />
			<img src="~/video/cartisempty.png" />

         </section>
       
    }
</div>


@section Scripts {
    <script>
        // 等待页面加载完成后执行
        document.addEventListener("DOMContentLoaded", function () {
            // 获取按钮元素
            var paymentButton = document.getElementById("paymentButton");

            // 添加点击事件监听器
            paymentButton.addEventListener("click", function () {
                // 调用请求支付函数
                requestPayment();
            });
        });

        // 定义 requestPayment() 函数
function requestPayment() {
            let baseLoginPayUrl = 'https://localhost:7150/api/LinePay/';

            let products = [];

            // 使用 Razor 循环遍历并构建 products 数组
        @foreach (var item in Model.T影片CartDetails)
        {
            <text>
                    let currentProduct = {
                        name: "@Html.Raw(item.FVideo.FVideoName)",
                        imageUrl: "https://static.accupass.com/org/2011051025162614811630.jpg",
                        quantity: @item.Quantity,
                        price: parseInt(@item.FVideo.FPrice)
                    };
                products.push(currentProduct);
            </text>
        }

                // 构建 payment 对象
                let payment = {
                    amount: parseInt(@Convert.ToInt32(Model.T影片CartDetails.Select(item => item.FVideo.FPrice * item.Quantity).Sum().ToString("0.##"))),
                    currency: "TWD",
                    orderId: Date.now().toString(),
                    packages: [
                        {
                            id: "20191011I001",
                            amount: parseInt(@Convert.ToInt32(Model.T影片CartDetails.Select(item => item.FVideo.FPrice * item.Quantity).Sum().ToString("0.##"))),
                            name: "測試",
                            products: products
                        }
                    ],
                    RedirectUrls: {
                        ConfirmUrl: "https://localhost:7150/video_management/videoforStudent/confirm/",
                        CancelUrl: "https://3a8e-114-37-157-213.jp.ngrok.io/api/LinePay/Cancel",
                    }
                };


            // 送出交易申请至商家 server
            $.post({
                url: baseLoginPayUrl + "Create",
                dataType: "json",
                contentType: "application/json",
                data: JSON.stringify(payment),
                success: (res) => {
                    window.location = res.info.paymentUrl.web;
                },
                error: (err) => {
                    console.log(err);
                }
            });
        }
     
          
       
    </script>
}